#include <DS3231.h>
#include <LedControl.h>

int sensorPin = A0; //PWM sensor pin
int brightness = 0;
unsigned devices = 4; //number of LED matrix panels
LedControl lc = LedControl(7, 6, 5, devices); //DIN, CLK, CS
DS3231 rtc(10, 9); //SDA, SCL
Time t;

byte digits [60][8] = {
  {B11111110, B00000000, B11101110, B10101010, B10101010, B10101010, B11101110, B00000000},
  {B11111110, B00000000, B10001110, B10001010, B10001010, B10001010, B10001110, B00000000},
  {B11111110, B00000000, B11101110, B00101010, B11101010, B10001010, B11101110, B00000000},
  {B11111110, B00000000, B11101110, B10001010, B11101010, B10001010, B11101110, B00000000},
  {B11111110, B00000000, B10001110, B10001010, B11101010, B10101010, B10101110, B00000000},
  {B11111110, B00000000, B11101110, B10001010, B11101010, B00101010, B11101110, B00000000},
  {B11111110, B00000000, B11101110, B10101010, B11101010, B00101010, B11101110, B00000000},
  {B11111110, B00000000, B10001110, B10001010, B10001010, B10001010, B11101110, B00000000},
  {B11111110, B00000000, B11101110, B10101010, B11101010, B10101010, B11101110, B00000000},
  {B11111110, B00000000, B11101110, B10001010, B11101010, B10101010, B11101110, B00000000},
  {B11111110, B00000000, B11101000, B10101000, B10101000, B10101000, B11101000, B00000000},
  {B11111110, B00000000, B10001000, B10001000, B10001000, B10001000, B10001000, B00000000},
  {B11111110, B00000000, B11101000, B00101000, B11101000, B10001000, B11101000, B00000000},
  {B11111110, B00000000, B11101000, B10001000, B11101000, B10001000, B11101000, B00000000},
  {B11111110, B00000000, B10001000, B10001000, B11101000, B10101000, B10101000, B00000000},
  {B11111110, B00000000, B11101000, B10001000, B11101000, B00101000, B11101000, B00000000},
  {B11111110, B00000000, B11101000, B10101000, B11101000, B00101000, B11101000, B00000000},
  {B11111110, B00000000, B10001000, B10001000, B10001000, B10001000, B11101000, B00000000},
  {B11111110, B00000000, B11101000, B10101000, B11101000, B10101000, B11101000, B00000000},
  {B11111110, B00000000, B11101000, B10001000, B11101000, B10101000, B11101000, B00000000},
  {B11111110, B00000000, B11101110, B10100010, B10101110, B10101000, B11101110, B00000000},
  {B11111110, B00000000, B10001110, B10000010, B10001110, B10001000, B10001110, B00000000},
  {B11111110, B00000000, B11101110, B00100010, B11101110, B10001000, B11101110, B00000000},
  {B11111110, B00000000, B11101110, B10000010, B11101110, B10001000, B11101110, B00000000},
  {B11111110, B00000000, B10001110, B10000010, B11101110, B10101000, B10101110, B00000000},
  {B11111110, B00000000, B11101110, B10000010, B11101110, B00101000, B11101110, B00000000},
  {B11111110, B00000000, B11101110, B10100010, B11101110, B00101000, B11101110, B00000000},
  {B11111110, B00000000, B10001110, B10000010, B10001110, B10001000, B11101110, B00000000},
  {B11111110, B00000000, B11101110, B10100010, B11101110, B10101000, B11101110, B00000000},
  {B11111110, B00000000, B11101110, B10000010, B11101110, B10101000, B11101110, B00000000},
  {B11111110, B00000000, B11101110, B10101000, B10101110, B10101000, B11101110, B00000000},
  {B11111110, B00000000, B10001110, B10001000, B10001110, B10001000, B10001110, B00000000},
  {B11111110, B00000000, B11101110, B00101000, B11101110, B10001000, B11101110, B00000000},
  {B11111110, B00000000, B11101110, B10001000, B11101110, B10001000, B11101110, B00000000},
  {B11111110, B00000000, B10001110, B10001000, B11101110, B10101000, B10101110, B00000000},
  {B11111110, B00000000, B11101110, B10001000, B11101110, B00101000, B11101110, B00000000},
  {B11111110, B00000000, B11101110, B10101000, B11101110, B00101000, B11101110, B00000000},
  {B11111110, B00000000, B10001110, B10001000, B10001110, B10001000, B11101110, B00000000},
  {B11111110, B00000000, B11101110, B10101000, B11101110, B10101000, B11101110, B00000000},
  {B11111110, B00000000, B11101110, B10001000, B11101110, B10101000, B11101110, B00000000},
  {B11111110, B00000000, B11101000, B10101000, B10101110, B10101010, B11101010, B00000000},
  {B11111110, B00000000, B10001000, B10001000, B10001110, B10001010, B10001010, B00000000},
  {B11111110, B00000000, B11101000, B00101000, B11101110, B10001010, B11101010, B00000000},
  {B11111110, B00000000, B11101000, B10001000, B11101110, B10001010, B11101010, B00000000},
  {B11111110, B00000000, B10001000, B10001000, B11101110, B10101010, B10101010, B00000000},
  {B11111110, B00000000, B11101000, B10001000, B11101110, B00101010, B11101010, B00000000},
  {B11111110, B00000000, B11101000, B10101000, B11101110, B00101010, B11101010, B00000000},
  {B11111110, B00000000, B10001000, B10001000, B10001110, B10001010, B11101010, B00000000},
  {B11111110, B00000000, B11101000, B10101000, B11101110, B10101010, B11101010, B00000000},
  {B11111110, B00000000, B11101000, B10001000, B11101110, B10101010, B11101010, B00000000},
  {B11111110, B00000000, B11101110, B10101000, B10101110, B10100010, B11101110, B00000000},
  {B11111110, B00000000, B10001110, B10001000, B10001110, B10000010, B10001110, B00000000},
  {B11111110, B00000000, B11101110, B00101000, B11101110, B10000010, B11101110, B00000000},
  {B11111110, B00000000, B11101110, B10001000, B11101110, B10000010, B11101110, B00000000},
  {B11111110, B00000000, B10001110, B10001000, B11101110, B10100010, B10101110, B00000000},
  {B11111110, B00000000, B11101110, B10001000, B11101110, B00100010, B11101110, B00000000},
  {B11111110, B00000000, B11101110, B10101000, B11101110, B00100010, B11101110, B00000000},
  {B11111110, B00000000, B10001110, B10001000, B10001110, B10000010, B11101110, B00000000},
  {B11111110, B00000000, B11101110, B10101000, B11101110, B10100010, B11101110, B00000000},
  {B11111110, B00000000, B11101110, B10001000, B11101110, B10100010, B11101110, B00000000}
};

byte dayOfWeek [7][8] = {
  {B01111111, B00000000, B00100101, B01010101, B01010111, B00100111, B00000101, B00000000},
  {B01111111, B00000000, B01100010, B01010010, B01010010, B00000010, B00000111, B00000000},
  {B01111111, B00000000, B01100101, B00110111, B01010111, B00100101, B00000101, B00000000},
  {B01111111, B00000000, B01010010, B01010010, B01010010, B00110010, B00010111, B00000000},
  {B01111111, B00000000, B00010001, B00010001, B01010111, B00110001, B00000111, B00000000},
  {B01111111, B00000000, B01100011, B01010100, B01010010, B01100001, B00000110, B00000000},
  {B01111111, B00000000, B01100011, B01010100, B01010010, B00000001, B00000110, B00000000}
};

void setup() {
  pinMode(sensorPin, INPUT); //setting the pin for the ambiend light sensor
  rtc.begin(); //starting up RTC module
  for(unsigned address = 0; address < devices; address++) { //turning on & clearing the LED modules
    lc.shutdown(address, false);
    lc.clearDisplay(address);
  }
}

void loop() {
  brightness = ((1023 - analogRead(sensorPin)) / 256) - 1; //getting the brightness for the LED matrix modules
  if (brightness < 0) {brightness = 0;}
  for (unsigned address = 0; address < devices; address++) { //setting the brightness of the LED matrix modules
    lc.setIntensity(address, brightness);
  }
  t = rtc.getTime();
  if (!t.hour && !t.min && !t.sec && !(t.date % 3)) { //RTC self correction
    rtc.setTime(t.hour, t.min, t.sec + 1);
    t = rtc.getTime();
  }
  for (unsigned row = 0; row < 9; row++) { //displaying day of week and time on the LED matrix modules
    lc.setRow(0, row, dayOfWeek[t.dow - 1][row]);
    lc.setRow(1, row, digits[t.hour][row]);
    lc.setRow(2, row, digits[t.min][row]);
    lc.setRow(3, row, digits[t.sec][row]);
  }
}
